<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com https://cdn.jsdelivr.net;
    font-src 'self' https://fonts.gstatic.com https://unpkg.com https://cdn.jsdelivr.net data:;
    img-src 'self' data: blob:;
    connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com https://cdn.tailwindcss.com https://pypi.org https://files.pythonhosted.org https://cdnjs.cloudflare.com;
    worker-src 'self' blob:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gbdraw Web App</title>
    <script src="https://unpkg.com/vue@3.5.25/dist/vue.global.js" integrity="sha384-E8hqvY4j8uyv6njj1udAOIuT4tsPt3lJET321mQPDQ29OMiTOYMuG/UDD6o52yW4" crossorigin="anonymous"></script>
    <!--
        SECURITY NOTE: TailwindCSS Play CDN uses JIT compilation, so Subresource Integrity (SRI)
        cannot be applied. This CDN dynamically generates CSS based on the page content.
        For production with stricter security requirements, consider using a static Tailwind build.
        See: https://tailwindcss.com/docs/installation
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js" integrity="sha384-l95tshxQlbjf4kdyWZf10uUL5Dw8/iN9q16SQ+ttOEWA8SN0cLG6BGDGY17GxToh" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.2/src/index.js" integrity="sha384-J7cw2fbG1T4C5MirTVUxsZGaMfw2m0XsCgOQEqUvB1OF9VIsHWuZF1GmyVRzs7eu" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js" integrity="sha384-GwHhSt8QjC7J+v0zZ0Flfho/T76YHEcCL9w4rvjTIUHauh6gWJeBSIi3vWXxNhtA" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.6.0/dist/svg2pdf.umd.min.js" integrity="sha384-UMdplNeJF/mRqnsNO/vfK5po5eKyTMGCymHkdARQ9NFscA4DX3buGxfhUJcPLbWj" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.7/purify.min.js" integrity="sha384-qJNkHwhlYywDHfyoEe1np+1lYvX/8x+3gHCKFhSSBMQyCFlvFnn+zXmaebXl21rV" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .card { @apply bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-3 transition-all; }
        .card-header { @apply text-lg font-bold mb-3 text-slate-700 flex items-center gap-2 border-b pb-2; }
        .input-group { @apply mb-3; }
        .input-label { @apply block text-base font-bold text-slate-500 uppercase tracking-wider mb-1.5 flex items-center gap-1; }
        .form-input { @apply w-full bg-slate-50 border border-slate-200 text-slate-700 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition-all; }
        .form-checkbox { @apply w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2; }

        .btn { @apply font-bold rounded-lg text-base px-4 py-2 shadow-sm transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2; }
        .btn-primary { @apply text-white bg-blue-600 hover:bg-blue-700; }
        .btn-secondary { @apply text-slate-700 bg-white border border-slate-300 hover:bg-slate-50; }
        .btn-danger { @apply text-red-600 bg-white border border-red-200 hover:bg-red-50; }
        .btn-sm { @apply px-2 py-1 text-xs; }

        /* Highlighted Generate Button Style */
        .btn-generate {
            @apply text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 border-b-4 border-indigo-800 shadow-lg shadow-indigo-200;
        }
        .btn-generate:active { @apply border-b-0 translate-y-1; }

        .upload-zone {
            background-color: #fefce8;
            @apply border-2 border-dashed border-slate-300 rounded-lg p-3 text-center cursor-pointer select-none hover:border-blue-500 hover:bg-blue-50 relative transition-colors flex flex-col items-center justify-center min-h-[60px]; 
        }
        .upload-zone.ready { @apply bg-green-50 border-green-500; }
        
        details > summary { @apply list-none cursor-pointer font-bold text-slate-600 hover:text-blue-600 transition-colors flex items-center gap-2 select-none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { @apply mb-4 text-blue-600; }
        details > summary::before { content: ''; @apply w-4 h-4 bg-contain bg-no-repeat transition-transform duration-200; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 18 15 12 9 6'%3E%3C/polyline%3E%3C/svg%3E"); }
        details[open] > summary::before { transform: rotate(90deg); }
    </style>
</head>
<body class="antialiased pb-0 overflow-hidden">

<div id="app" class="h-screen flex flex-col relative">
    
    <div v-if="!pyodideReady" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-4 text-center">
        <div class="animate-spin text-5xl mb-6">ðŸ§¬</div>
        <h3 class="text-2xl font-bold text-slate-800">Initializing gbdraw Serverless...</h3>
        <p class="text-slate-500 mt-2">Loading Python engine (Pyodide) and dependencies.</p>
        <p class="text-xs text-slate-400 mt-4 font-mono">{{ loadingStatus }}</p>
    </div>

    <div v-if="processing" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
        <div class="animate-spin w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full mb-6"></div>
        <h3 class="text-xl font-bold text-slate-800 animate-pulse">Generating Diagram...</h3>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm/50 backdrop-blur-md bg-white/90 h-14 shrink-0">
        <div class="px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold text-lg shadow-md">ðŸ§¬</div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight flex items-baseline">
                    gbdraw
                    <span class="text-slate-400 text-sm font-normal ml-3">A genome diagram generator for microbes and organelles</span>
                </h1>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex gap-1 mr-4">
                    <button @click="exportConfig" class="text-xs font-bold text-slate-500 hover:text-blue-600 px-2 py-1 rounded border border-slate-200 bg-white flex items-center gap-1">
                        <i class="ph ph-export"></i> Save Config
                    </button>
                    <button @click="$refs.configInput.click()" class="text-xs font-bold text-slate-500 hover:text-blue-600 px-2 py-1 rounded border border-slate-200 bg-white flex items-center gap-1">
                        <i class="ph ph-arrow-square-in"></i> Load Config
                    </button>
                    <input type="file" ref="configInput" class="hidden" @change="importConfig">
                </div>

                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button @click="mode = 'circular'" :class="mode === 'circular' ? 'bg-white text-blue-600 shadow ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all flex items-center gap-2"><i class="ph ph-circle"></i> Circular</button>
                    <button @click="mode = 'linear'" :class="mode === 'linear' ? 'bg-white text-blue-600 shadow ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all flex items-center gap-2"><i class="ph ph-ruler"></i> Linear</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow px-4 py-3 flex overflow-hidden h-[calc(100vh-88px)]">

        <div class="flex flex-col h-full overflow-hidden relative shrink-0"
             :style="{ width: sidebarWidth + 'px' }">
            
            <div class="flex-grow overflow-y-auto custom-scrollbar pr-2 pb-4 space-y-4">
                
                <div class="card border-l-4 border-l-blue-500">
                    <div class="card-header"><i class="ph ph-folder-open text-xl"></i> Input Genomes</div>
                    
                    <div v-if="mode === 'circular'" class="space-y-4">
                        <div class="flex gap-4 text-sm font-bold bg-slate-50 p-2 rounded-lg inline-flex">
                            <label class="flex items-center gap-2 cursor-pointer hover:text-blue-600"><input type="radio" v-model="cInputType" value="gb" class="text-blue-600 focus:ring-blue-500"> GenBank</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-blue-600"><input type="radio" v-model="cInputType" value="gff" class="text-blue-600 focus:ring-blue-500"> GFF3 + FASTA</label>
                        </div>
                        <div v-if="cInputType === 'gb'">
                            <file-uploader label="GenBank File (.gb)" v-model="files.c_gb"></file-uploader>
                        </div>
                        <div v-else class="grid grid-cols-1 gap-3">
                            <file-uploader label="GFF3 File" v-model="files.c_gff"></file-uploader>
                            <file-uploader label="FASTA File" v-model="files.c_fasta"></file-uploader>
                        </div>
                    </div>

                    <div v-if="mode === 'linear'" class="space-y-4">
                        <div class="flex gap-4 text-sm font-bold bg-slate-50 p-2 rounded-lg inline-flex mb-2">
                            <label class="flex items-center gap-2 cursor-pointer hover:text-blue-600"><input type="radio" v-model="lInputType" value="gb" class="text-blue-600"> GenBank</label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-blue-600"><input type="radio" v-model="lInputType" value="gff" class="text-blue-600"> GFF3 + FASTA</label>
                        </div>
                        <div v-for="(seq, idx) in linearSeqs" :key="idx" class="p-3 bg-slate-50 rounded-lg border border-slate-200 relative group text-sm transition-all hover:border-blue-300">
                            <div class="absolute top-2 right-2 text-[10px] font-bold text-white bg-slate-400 px-1.5 py-0.5 rounded-full">#{{ idx + 1 }}</div>
                            <div v-if="lInputType === 'gb'" class="space-y-2">
                                <file-uploader label="GenBank File" v-model="seq.gb"></file-uploader>
                            </div>
                            <div v-else class="space-y-2 mb-2">
                                <file-uploader label="GFF3" v-model="seq.gff"></file-uploader>
                                <file-uploader label="FASTA" v-model="seq.fasta"></file-uploader>
                            </div>
                            <div v-if="idx < linearSeqs.length - 1" class="mt-2 pt-2 border-t border-slate-200 border-dashed">
                                <div class="text-[10px] text-slate-500 font-bold mb-1 flex items-center gap-1"><i class="ph ph-arrows-down-up"></i> Compare to next (BLAST)</div>
                                <file-uploader label="BLAST TSV" v-model="seq.blast"></file-uploader>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="linearSeqs.push({gb:null, gff:null, fasta:null, blast:null})" class="btn btn-secondary text-xs w-full"><i class="ph ph-plus"></i> Add Seq</button>
                            <button v-if="linearSeqs.length > 1" @click="linearSeqs.pop()" class="btn btn-danger text-xs w-full"><i class="ph ph-minus"></i> Remove</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><i class="ph ph-sliders"></i> Basic Settings</div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="input-label">Output Prefix <help-tip text="Prefix for output files. Leave empty to use the record name (e.g., NC_000xxx)."></help-tip></label>
                                <input type="text" v-model="form.prefix" class="form-input" placeholder="Optional (Default: Record ID)">
                            </div>
                             <div>
                                <label class="input-label">Legend <help-tip text="Position of the legend. 'None' hides the legend."></help-tip></label>
                                <select v-model="form.legend" class="form-input">
                                    <option value="right">Right</option><option value="left">Left</option>
                                    <option value="top" v-if="mode==='linear'">Top</option><option value="bottom" v-if="mode==='linear'">Bottom</option>
                                    <option value="upper_left" v-if="mode==='circular'">Upper Left</option><option value="upper_right" v-if="mode==='circular'">Upper Right</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                        </div>
                       
                        <div v-if="mode === 'circular'">
                            <label class="input-label">Track Layout <help-tip text="Choose how features are displayed. 'Tuckin' is default and compact. 'Middle' aligns to center, 'Spreadout' separates them."></help-tip></label>
                            <select v-model="form.track_type" class="form-input"><option value="tuckin">Tuckin (Compact)</option><option value="middle">Middle</option><option value="spreadout">Spreadout</option></select>
                        </div>

                        <div v-if="mode === 'linear'">
                             <label class="input-label">Scale Style <help-tip text="'Bar' draws a simple line, 'Ruler' draws a ruler with ticks and labels."></help-tip></label>
                             <select v-model="form.scale_style" class="form-input"><option value="bar">Bar (Simple)</option><option value="ruler">Ruler (Ticks)</option></select>
                        </div>

                        <div class="grid grid-cols-2 gap-y-2 gap-x-1 p-2 bg-slate-50 rounded-lg">
                            <div v-if="mode === 'linear'" class="col-span-2 mb-1">
                                <label class="input-label text-[10px] mb-1">Show Labels <help-tip text="Display feature labels on the map. 'First' shows labels only for the top track."></help-tip></label>
                                <select v-model="form.show_labels_linear" class="form-input text-xs py-1">
                                    <option value="none">None</option>
                                    <option value="all">All Records</option>
                                    <option value="first">First Record Only</option>
                                </select>
                            </div>
                            <label v-else class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                <input type="checkbox" v-model="form.show_labels" class="form-checkbox"> Show Labels <help-tip text="Display feature labels on the map."></help-tip>
                            </label>

                            <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                <input type="checkbox" v-model="form.separate_strands" class="form-checkbox"> Separate Strands <help-tip text="Display features on separate strands for better distinction."></help-tip>
                            </label>
                            
                            <template v-if="mode === 'circular'">
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.allow_inner_labels" class="form-checkbox"> Inner Labels <help-tip text="Enable labels inside the circle. Automatically suppresses GC content/skew to avoid overlap."></help-tip>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.suppress_gc" class="form-checkbox"> Hide GC <help-tip text="Suppress the GC content track."></help-tip>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.suppress_skew" class="form-checkbox"> Hide Skew <help-tip text="Suppress the GC skew track."></help-tip>
                                </label>
                            </template>
                            
                            <template v-if="mode === 'linear'">
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="adv.resolve_overlaps" class="form-checkbox"> Resolve Overlaps <help-tip text="Shift features vertically to avoid overlap. (Experimental)"></help-tip>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.align_center" class="form-checkbox"> Align Center <help-tip text="Align the linear map to the center of the page."></help-tip>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.normalize_length" class="form-checkbox"> Normalize Len <help-tip text="Normalize sequence lengths to be equal. Suppresses length bar."></help-tip>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.show_gc" class="form-checkbox"> Show GC <help-tip text="Display GC content track."></help-tip>
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer select-none">
                                    <input type="checkbox" v-model="form.show_skew" class="form-checkbox"> Show Skew <help-tip text="Display GC skew track."></help-tip>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="card bg-slate-50/50">
                    <details>
                        <summary><i class="ph ph-palette"></i> Colors & Filters <help-tip text="Customize colors and filter labels by keyword."></help-tip></summary>
                        <div class="mt-4 space-y-6 pt-4 border-t border-slate-200">
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-xs font-bold text-slate-500">DEFAULT COLORS (-d) <help-tip text="Base colors for features. Acts as the -d override table."></help-tip></h4>
                                    <button @click="resetColors" class="text-[10px] text-blue-600 hover:underline">Reset</button>
                                </div>
                                <select v-model="selectedPalette" @change="updatePalette" class="form-input mb-3">
                                    <option v-for="p in paletteNames" :value="p">{{ p }}</option>
                                </select>
                                <div class="grid grid-cols-5 gap-1.5 bg-white p-2 rounded border border-slate-200">
                                    <div v-for="(color, feat) in currentColors" :key="feat" class="flex flex-col items-center group relative cursor-pointer">
                                        <input type="color" v-model="currentColors[feat]" class="w-8 h-8 p-0 border-0 rounded cursor-pointer transition-transform hover:scale-110">
                                        <span class="text-[9px] text-slate-500 mt-0.5 truncate w-full text-center" :title="feat">{{ feat }}</span>
                                    </div>
                                </div>

                                <div class="mt-2 p-2 bg-slate-50 rounded border border-slate-200 flex gap-2 items-end">
                                    <div class="flex-grow">
                                        <label class="text-[9px] font-bold text-slate-500 block mb-1">ADD FEATURE</label>
                                        <select v-model="newColorFeat" class="form-input text-xs py-1 px-2 h-8">
                                            <option v-for="k in featureKeys" :value="k">{{ k }}</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-[9px] font-bold text-slate-500 block mb-1">COLOR</label>
                                        <input type="color" v-model="newColorVal" class="h-8 w-10 p-0 border border-slate-300 rounded cursor-pointer">
                                    </div>
                                    <button @click.prevent="addCustomColor" class="btn btn-secondary text-xs h-8">
                                        <i class="ph ph-plus"></i> Add
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <div class="text-[10px] text-center text-slate-400 mb-1">- OR UPLOAD FILE -</div>
                                    <file-uploader label="Override File (-d)" v-model="files.d_color" :small="true"></file-uploader>
                                    <div class="text-[9px] text-slate-400 mt-1">
                                        <help-tip text="Tab-separated value (TSV) file that overrides the color palette. Feature types not specified will use the selected palette colors."></help-tip> 
                                        Override default feature colors.
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-xs font-bold text-slate-500">SPECIFIC RULES (-t) <help-tip text="Color features matching specific qualifier values (Regex supported)."></help-tip></h4>
                                    <button v-if="manualSpecificRules.length > 0" @click="clearAllSpecificRules" class="text-[10px] text-red-500 hover:text-red-700 hover:underline"><i class="ph ph-trash"></i> Clear All</button>
                                </div>

                                <div class="space-y-1 mb-3">
                                    <div v-for="(rule, i) in manualSpecificRules" :key="i" class="flex items-center gap-1 bg-white p-1 rounded border border-slate-200 text-[10px]">
                                        <span class="w-12 font-bold truncate" :title="rule.feat">{{rule.feat}}</span>
                                        <span class="w-12 text-slate-500 truncate" :title="rule.qual">{{rule.qual}}</span>
                                        <span class="flex-grow text-blue-600 truncate font-mono" :title="rule.val">/{{rule.val}}/</span>
                                        <div class="w-4 h-4 rounded border" :style="{backgroundColor: rule.color}"></div>
                                        <button @click="manualSpecificRules.splice(i,1)" class="text-red-500 hover:text-red-700 px-1"><i class="ph ph-trash"></i></button>
                                    </div>
                                    <div v-if="manualSpecificRules.length === 0" class="text-[10px] text-slate-400 italic text-center py-2">No rules added</div>
                                </div>

                                <div class="bg-slate-50 p-2 rounded border border-slate-200">
                                    <div class="grid grid-cols-2 gap-1 mb-1">
                                        <select v-model="newSpecRule.feat" class="form-input text-xs p-1 h-7">
                                            <option v-for="k in featureKeys" :value="k">{{ k }}</option>
                                        </select>
                                        <input v-model="newSpecRule.qual" placeholder="Qualifier" class="form-input text-xs p-1 h-7">
                                    </div>
                                    <div class="flex gap-1 mb-1">
                                        <input v-model="newSpecRule.val" placeholder="Regex (e.g. hypothetical)" class="form-input text-xs p-1 h-7 flex-grow">
                                        <input type="color" v-model="newSpecRule.color" class="h-7 w-8 p-0 border rounded cursor-pointer shrink-0">
                                    </div>
                                    <div class="flex gap-1">
                                        <input v-model="newSpecRule.cap" placeholder="Legend Caption (Optional)" class="form-input text-xs p-1 h-7 flex-grow">
                                        <button @click="addSpecificRule" class="btn btn-secondary text-xs h-7 px-3"><i class="ph ph-plus"></i></button>
                                    </div>
                                </div>

                                <div class="mt-2">
                                    <div class="text-[10px] text-center text-slate-400 mb-1">- OR UPLOAD FILE -</div>
                                    <file-uploader label="Specific Table (-t)" v-model="files.t_color" :small="true"></file-uploader>
                                    <div class="text-[9px] text-slate-400 mt-1">
                                        <help-tip text="TSV file that overrides the color palette for specific features based on qualifiers."></help-tip>
                                        Override colors for specific features.
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="text-xs font-bold text-slate-500 mb-2">LABEL FILTERING <help-tip text="Control which feature labels are displayed using Blacklist or Whitelist."></help-tip></h4>
                                <div class="flex gap-2 mb-2">
                                    <button v-for="m in ['None', 'Blacklist', 'Whitelist']" @click="filterMode = m" :class="filterMode===m ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 border'" class="flex-1 py-1 rounded text-xs font-bold transition-colors">{{m}}</button>
                                </div>
                                
                                <div v-if="filterMode === 'Blacklist'" class="space-y-2 bg-white p-2 rounded border">
                                    <p class="text-[10px] text-slate-500">Exclude labels containing these keywords.</p>
                                    <textarea v-model="manualBlacklist" class="form-input h-20" placeholder="hypothetical, unknown"></textarea>
                                    <div class="text-[10px] text-center text-slate-400">- OR -</div>
                                    <file-uploader label="Blacklist File" v-model="files.blacklist" :small="true"></file-uploader>
                                </div>

                                <div v-if="filterMode === 'Whitelist'" class="space-y-2 bg-white p-2 rounded border">
                                    <p class="text-[10px] text-slate-500">Only show labels matching rules.</p>
                                    <div v-for="(row, i) in manualWhitelist" :key="i" class="flex gap-1 mb-1">
                                        <input v-model="row.feat" placeholder="Feat" class="form-input px-1 py-1 text-xs w-1/4">
                                        <input v-model="row.qual" placeholder="Qual" class="form-input px-1 py-1 text-xs w-1/4">
                                        <input v-model="row.key" placeholder="Keyword" class="form-input px-1 py-1 text-xs w-1/3">
                                        <button @click="manualWhitelist.splice(i,1)" class="text-red-500 hover:text-red-700 px-1">Ã—</button>
                                    </div>
                                    <button @click="manualWhitelist.push({feat:'CDS', qual:'product', key:''})" class="text-xs text-blue-600 font-bold">+ Add Rule</button>
                                    <div class="text-[10px] text-center text-slate-400 mt-2">- OR -</div>
                                    <file-uploader label="Whitelist File" v-model="files.whitelist" :small="true"></file-uploader>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-slate-100">
                                    <h5 class="text-[10px] font-bold text-slate-500 mb-2">QUALIFIER PRIORITY <help-tip text="Define label priority order (e.g. CDS -> product,gene,locus_tag)."></help-tip></h5>
                                    
                                    <div class="space-y-1 mb-3">
                                        <div v-for="(rule, i) in manualPriorityRules" :key="i" class="flex items-center gap-1 bg-white p-1 rounded border border-slate-200 text-[10px]">
                                            <span class="w-16 font-bold truncate shrink-0" :title="rule.feat">{{rule.feat}}</span>
                                            <span class="flex-grow text-slate-600 truncate font-mono" :title="rule.order">{{rule.order}}</span>
                                            <button @click="manualPriorityRules.splice(i,1)" class="text-red-500 hover:text-red-700 px-1"><i class="ph ph-trash"></i></button>
                                        </div>
                                        <div v-if="manualPriorityRules.length === 0" class="text-[10px] text-slate-400 italic text-center py-2">No priority rules defined</div>
                                    </div>

                                    <div class="bg-slate-50 p-2 rounded border border-slate-200 mb-2">
                                        <div class="flex gap-1 mb-1">
                                            <select v-model="newPriorityRule.feat" class="form-input text-xs p-1 h-7 w-24 shrink-0">
                                                <option v-for="k in featureKeys" :value="k">{{ k }}</option>
                                            </select>
                                            <input v-model="newPriorityRule.order" placeholder="product,gene,locus_tag" class="form-input text-xs p-1 h-7 flex-grow">
                                            <button @click="addPriorityRule" class="btn btn-secondary text-xs h-7 px-3"><i class="ph ph-plus"></i></button>
                                        </div>
                                    </div>

                                    <div class="text-[10px] text-center text-slate-400 mb-1">- OR UPLOAD FILE -</div>
                                    <file-uploader label="Priority File (TSV)" v-model="files.qualifier_priority" :small="true"></file-uploader>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <div class="border-t border-slate-200 my-2"></div>
                    
                    <details>
                        <summary><i class="ph ph-faders"></i> Advanced Options</summary>
                        <div class="mt-4 space-y-4 pt-4 border-t border-slate-200">
                            
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="input-label text-[10px]">Window <help-tip text="Window size for GC content/skew. Default: 1kb (<1Mb), 10kb (<10Mb), 100kb (>=10Mb)."></help-tip></label><input type="number" v-model.number="adv.window_size" class="form-input" placeholder="Auto"></div>
                                <div><label class="input-label text-[10px]">Step <help-tip text="Step size for GC content/skew. Default: 100bp (<1Mb), 1kb (<10Mb), 10kb (>=10Mb)."></help-tip></label><input type="number" v-model.number="adv.step_size" class="form-input" placeholder="Auto"></div>
                                <div><label class="input-label text-[10px]">Dinucleotide <help-tip text="Dinucleotide to use (e.g., 'GC'). Default is 'GC'."></help-tip></label><input type="text" v-model="adv.nt" class="form-input" placeholder="GC"></div>
                            </div>

                            <div>
                                <template v-if="mode === 'circular'">
                                    <label class="input-label">Definition & Text</label>
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <input type="text" v-model="form.species" class="form-input" placeholder="Species (e.g. <i>Escherichia coli</i>)">
                                        <input type="text" v-model="form.strain" class="form-input" placeholder="Strain (e.g. K-12)">
                                    </div>
                                </template>

                                <label v-if="mode === 'linear'" class="input-label">Label Settings</label>

                                <div class="grid grid-cols-2 gap-2">
                                    <div v-if="mode === 'circular'">
                                        <label class="text-[9px] text-slate-400">Def Font Size <help-tip text="Font size for the species/strain definition text."></help-tip></label>
                                        <input type="number" v-model.number="adv.def_font_size" class="form-input" placeholder="18">
                                    </div>
                                    
                                    <div :class="mode === 'linear' ? 'col-span-2' : ''">
                                        <label class="text-[9px] text-slate-400">Label Font Size <help-tip text="Font size for feature labels."></help-tip></label>
                                        <input type="number" v-model.number="adv.label_font_size" class="form-input" placeholder="Auto">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="input-label text-[10px]">Legend Box Size <help-tip text="Size of the color boxes in the legend."></help-tip></label><input type="number" v-model.number="adv.legend_box_size" class="form-input" placeholder="Auto"></div>
                                <div><label class="input-label text-[10px]">Legend Font Size <help-tip text="Font size for the legend text."></help-tip></label><input type="number" v-model.number="adv.legend_font_size" class="form-input" placeholder="Auto"></div>
                            </div>

                            <div>
                                <label class="input-label">Styles (Colors & Widths)</label>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="text-[9px] block">Block Stroke Color <help-tip text="Color of the outline for feature blocks."></help-tip></label><input type="color" v-model="adv.block_stroke_color" class="h-6 w-full p-0 border rounded"></div>
                                        <div><label class="text-[9px] block">Block Stroke Width <help-tip text="Width of the outline for feature blocks."></help-tip></label><input type="number" v-model.number="adv.block_stroke_width" class="form-input py-0.5" placeholder="Auto"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="text-[9px] block">Line Stroke Color <help-tip text="Color of the lines representing introns."></help-tip></label><input type="color" v-model="adv.line_stroke_color" class="h-6 w-full p-0 border rounded"></div>
                                        <div><label class="text-[9px] block">Line Stroke Width <help-tip text="Width of the lines representing introns."></help-tip></label><input type="number" v-model.number="adv.line_stroke_width" class="form-input py-0.5" placeholder="Auto"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="text-[9px] block">Axis Stroke Color <help-tip text="Color of the main axis line."></help-tip></label><input type="color" v-model="adv.axis_stroke_color" class="h-6 w-full p-0 border rounded"></div>
                                        <div><label class="text-[9px] block">Axis Stroke Width <help-tip text="Width of the main axis line."></help-tip></label><input type="number" v-model.number="adv.axis_stroke_width" class="form-input py-0.5" placeholder="Auto"></div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="mode === 'linear'">
                                <label class="input-label">Linear Specific Settings</label>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 space-y-2">
                                    <div class="grid grid-cols-3 gap-1 text-xs">
                                        <div><label class="text-[9px] block">Feature H <help-tip text="Height of the feature blocks."></help-tip></label><input type="number" v-model.number="adv.feature_height" class="form-input px-1 py-0.5"></div>
                                        <div><label class="text-[9px] block">GC H <help-tip text="Height of the GC content track."></help-tip></label><input type="number" v-model.number="adv.gc_height" class="form-input px-1 py-0.5"></div>
                                        <div><label class="text-[9px] block">Comp H <help-tip text="Height of the comparison blocks."></help-tip></label><input type="number" v-model.number="adv.comparison_height" class="form-input px-1 py-0.5"></div>
                                    </div>
                                    
                                    <div class="pt-1 border-t border-slate-200">
                                        <label class="text-[9px] font-bold block mb-1">SCALE BAR</label>
                                        <div class="grid grid-cols-3 gap-1">
                                            <input type="number" v-model.number="adv.scale_interval" placeholder="Interval" class="form-input px-1 py-0.5 text-xs" title="Manual tick interval">
                                            <input type="number" v-model.number="adv.scale_font_size" placeholder="Font" class="form-input px-1 py-0.5 text-xs" title="Scale font size">
                                            <input type="number" v-model.number="adv.scale_stroke_width" placeholder="Width" class="form-input px-1 py-0.5 text-xs" title="Scale bar width">
                                        </div>
                                        <div class="mt-1 flex items-center gap-2">
                                            <label class="text-[9px]">Color:</label>
                                            <input type="color" v-model="adv.scale_stroke_color" class="h-5 w-8 p-0 border rounded" title="Scale bar color">
                                        </div>
                                    </div>

                                    <div class="pt-1 border-t border-slate-200">
                                        <label class="text-[9px] font-bold block mb-1">BLAST FILTERS</label>
                                        <div class="grid grid-cols-3 gap-1">
                                            <input type="number" v-model.number="adv.min_bitscore" placeholder="Bitscore" class="form-input px-1 text-xs" title="Min bitscore">
                                            <input type="text" v-model="adv.evalue" placeholder="E-value" class="form-input px-1 text-xs" title="Max E-value">
                                            <input type="number" v-model.number="adv.identity" placeholder="Ident%" class="form-input px-1 text-xs" title="Min identity %">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="mode === 'circular'">
                                <label class="input-label">Circular Label Offsets <help-tip text="Adjust radius offset factors for labels."></help-tip></label>
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 grid grid-cols-2 gap-2 text-xs">
                                    <div><label class="text-[9px] block">Outer X Offset</label><input type="number" step="0.1" v-model.number="adv.outer_label_x_offset" class="form-input py-0.5"></div>
                                    <div><label class="text-[9px] block">Outer Y Offset</label><input type="number" step="0.1" v-model.number="adv.outer_label_y_offset" class="form-input py-0.5"></div>
                                    <div><label class="text-[9px] block">Inner X Offset</label><input type="number" step="0.1" v-model.number="adv.inner_label_x_offset" class="form-input py-0.5"></div>
                                    <div><label class="text-[9px] block">Inner Y Offset</label><input type="number" step="0.1" v-model.number="adv.inner_label_y_offset" class="form-input py-0.5"></div>
                                    <div><label class="text-[9px] block">Scale Interval</label><input type="number" v-model.number="adv.scale_interval" class="form-input py-0.5"></div>
                                </div>
                            </div>

                            <div>
                                <label class="input-label">Include Features <help-tip text="Select which feature types to draw."></help-tip></label>
                                <div class="flex flex-wrap gap-2 mb-2 p-2 bg-slate-50 rounded border border-slate-200 min-h-[38px]">
                                    <span v-for="(f, i) in adv.features" :key="f" class="inline-flex items-center gap-1 text-[10px] bg-white text-blue-700 px-2 py-1 rounded border border-blue-200 shadow-sm">
                                        {{ f }}
                                        <button @click="adv.features.splice(i, 1)" class="text-slate-400 hover:text-red-500 flex items-center justify-center w-4 h-4 rounded-full hover:bg-red-50 transition-colors">
                                            <i class="ph ph-x"></i>
                                        </button>
                                    </span>
                                    <span v-if="adv.features.length === 0" class="text-[10px] text-slate-400 italic py-1">No features selected</span>
                                </div>
                                <div class="flex gap-2">
                                    <select v-model="newFeatureToAdd" class="form-input text-xs py-1 px-2 h-8">
                                        <option v-for="k in featureKeys" :value="k">{{ k }}</option>
                                    </select>
                                    <button @click.prevent="addFeature" class="btn btn-secondary text-xs h-8 shrink-0">
                                        <i class="ph ph-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="card bg-slate-50/50">
                    <details>
                        <summary><i class="ph ph-info"></i> About & Citation</summary>
                        <div class="mt-4 space-y-4 pt-4 border-t border-slate-200 text-xs text-slate-600">
                            
                            <div class="bg-blue-50 text-blue-800 p-2.5 rounded-lg border border-blue-100 leading-relaxed">
                                <strong class="flex items-center gap-1 mb-1"><i class="ph ph-lock-key"></i> Privacy & Security</strong>
                                This tool runs <strong>entirely in your browser</strong> using WebAssembly (Pyodide). Your genomic data is processed locally and never leaves your device.
                            </div>

                            <div>
                                <strong class="block mb-1 text-slate-700 flex items-center gap-1"><i class="ph ph-quotes"></i> Citation</strong>
                                <p class="mb-1.5 text-[11px]">If you use gbdraw in your research, please cite the GitHub repository:</p>
                                <div class="bg-white p-2 rounded border border-slate-200 font-mono text-[10px] select-all text-slate-500 break-all">
                                    https://github.com/satoshikawato/gbdraw
                                </div>
                            </div>

                            <div class="flex gap-2">
                                <a href="https://github.com/satoshikawato/gbdraw" target="_blank" rel="noopener noreferrer" class="btn btn-secondary btn-sm justify-center flex-1">
                                    <i class="ph ph-github-logo text-lg"></i> GitHub
                                </a>
                                <a href="https://github.com/satoshikawato/gbdraw/issues" target="_blank" rel="noopener noreferrer" class="btn btn-secondary btn-sm justify-center flex-1">
                                    <i class="ph ph-bug text-lg"></i> Issues
                                </a>
                            </div>
                        </div>
                    </details>
                </div>

            </div>
            
            <div class="shrink-0 py-4 bg-white/50 backdrop-blur-sm border-t border-slate-100 z-10 relative mt-auto">
            <button @click="runAnalysis" :disabled="processing || !pyodideReady" 
                class="btn w-full py-4 text-lg relative overflow-hidden group text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 active:shadow-none transition-all">
                <span v-if="!processing" class="flex items-center justify-center gap-2"><i class="ph ph-rocket-launch text-2xl"></i> Generate Diagram</span>
                <span v-else class="flex items-center justify-center gap-2"><i class="ph ph-spinner animate-spin text-xl"></i> Processing...</span>
            </button>
            </div>

        </div>

        <!-- Resize Handle -->
        <div class="w-1 bg-slate-200 hover:bg-blue-400 cursor-col-resize transition-colors shrink-0 mx-2"
             @mousedown="startResizing"
             title="Drag to resize"></div>

        <div class="flex-1 space-y-4 flex flex-col h-full overflow-hidden min-w-0">
            
            <div v-if="errorLog" class="card border-l-4 border-l-red-500 bg-red-50 mb-0 shrink-0">
                <div class="text-red-700 font-bold mb-2 flex items-center gap-2"><i class="ph ph-warning-circle"></i> Error Occurred</div>
                <pre class="text-xs font-mono text-red-800 whitespace-pre-wrap overflow-auto max-h-40 bg-white/50 p-3 rounded custom-scrollbar">{{ errorLog }}</pre>
            </div>

            <div v-if="results.length > 0" class="card border-2 border-green-100 ring-4 ring-green-50/50 flex flex-col flex-grow overflow-hidden relative">
                <div class="card-header bg-green-50/50 -m-4 mb-0 p-3 pl-5 pr-6 border-green-100 flex justify-between items-center shrink-0 flex-wrap gap-2">
                    <span class="text-green-600 flex items-center gap-2 text-base font-bold">
                        <i class="ph ph-check-circle text-xl"></i>
                        <span v-if="results.length === 1">Result Preview</span>
                        <span v-else>
                            <select v-model="selectedResultIndex" class="bg-white border border-green-300 text-green-700 text-sm font-bold rounded py-1 px-2 cursor-pointer focus:ring-2 focus:ring-green-500">
                                <option v-for="(res, idx) in results" :key="idx" :value="idx">Preview: {{ res.name }}</option>
                            </select>
                        </span>
                    </span>
                    <div class="flex gap-2 items-center flex-wrap mr-2">
                        <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded border border-green-200">
                            <span class="text-sm font-bold text-green-700">DPI</span>
                            <select v-model="downloadDpi" class="text-sm bg-transparent border-none focus:ring-0 p-0 text-slate-600 font-mono outline-none cursor-pointer">
                                <option value="72">72 (Web)</option>
                                <option value="96">96 (Screen)</option>
                                <option value="150">150 (Draft)</option>
                                <option value="300">300 (Print)</option>
                                <option value="600">600 (High)</option>
                            </select>
                        </div>
                        <button @click="downloadSVG" class="btn btn-secondary text-sm"><i class="ph ph-download-simple"></i> SVG</button>
                        <button @click="downloadPNG" class="btn btn-primary text-sm"><i class="ph ph-download-simple"></i> PNG</button>
                        <button @click="downloadPDF" class="btn btn-secondary text-sm"><i class="ph ph-file-pdf"></i> PDF</button>
                    </div>
                </div>

                <div class="relative flex-grow overflow-hidden bg-slate-50/30">

                    <!-- Zoom and Canvas controls -->
                    <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-20">
                        <!-- Reset all positions button -->
                        <button v-if="svgContent" @click="resetAllPositions"
                                class="w-8 h-8 flex items-center justify-center bg-white shadow rounded-lg border border-slate-200 hover:bg-slate-100 text-slate-600"
                                title="Reset all element positions"
                                aria-label="Reset all element positions">
                            <i class="ph ph-arrow-counter-clockwise"></i>
                        </button>
                        <!-- Canvas size toggle -->
                        <button v-if="svgContent" @click="showCanvasControls = !showCanvasControls"
                                class="w-8 h-8 flex items-center justify-center bg-white shadow rounded-lg border border-slate-200 hover:bg-slate-100 text-slate-600"
                                :class="{ 'bg-blue-50 text-blue-600 border-blue-300': showCanvasControls }"
                                title="Canvas padding controls"
                                aria-label="Toggle canvas padding controls">
                            <i class="ph ph-frame-corners"></i>
                        </button>
                        <!-- Zoom controls -->
                        <div class="flex gap-1 bg-white shadow rounded-lg p-1 border border-slate-200">
                            <button @click="zoom+=0.1" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-600 rounded" aria-label="Zoom in"><i class="ph ph-plus"></i></button>
                            <button @click="zoom = 1.0" class="w-12 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-600 text-xs font-mono rounded" aria-label="Reset zoom">{{Math.round(zoom*100)}}%</button>
                            <button @click="zoom = Math.max(0.1, zoom-0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 text-slate-600 rounded" aria-label="Zoom out"><i class="ph ph-minus"></i></button>
                        </div>
                    </div>

                    <!-- Drag hint -->
                    <div v-if="svgContent" class="absolute top-4 left-4 bg-white/90 shadow rounded-lg px-4 py-2 z-20 border border-slate-200">
                        <p class="text-sm text-slate-500 flex items-center gap-2">
                            <i class="ph ph-hand-grabbing text-base"></i> Drag diagram or legend to reposition
                        </p>
                    </div>

                    <!-- Canvas padding controls panel -->
                    <div v-if="showCanvasControls && svgContent"
                         class="absolute bottom-4 right-36 bg-white shadow-lg rounded-lg p-3 z-20 border border-slate-200 w-48">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-slate-700">Canvas Padding</span>
                            <button @click="resetCanvasPadding" class="text-[10px] text-blue-600 hover:text-blue-800">Reset</button>
                        </div>
                        <div class="grid grid-cols-3 gap-1 text-center">
                            <div></div>
                            <div>
                                <label class="text-[9px] text-slate-400 block">Top</label>
                                <input type="number" v-model.number="canvasPadding.top" step="10" class="w-full text-xs border rounded px-1 py-0.5 text-center">
                            </div>
                            <div></div>
                            <div>
                                <label class="text-[9px] text-slate-400 block">Left</label>
                                <input type="number" v-model.number="canvasPadding.left" step="10" class="w-full text-xs border rounded px-1 py-0.5 text-center">
                            </div>
                            <div class="flex items-center justify-center">
                                <i class="ph ph-selection-background text-slate-300 text-lg"></i>
                            </div>
                            <div>
                                <label class="text-[9px] text-slate-400 block">Right</label>
                                <input type="number" v-model.number="canvasPadding.right" step="10" class="w-full text-xs border rounded px-1 py-0.5 text-center">
                            </div>
                            <div></div>
                            <div>
                                <label class="text-[9px] text-slate-400 block">Bottom</label>
                                <input type="number" v-model.number="canvasPadding.bottom" step="10" class="w-full text-xs border rounded px-1 py-0.5 text-center">
                            </div>
                            <div></div>
                        </div>
                        <p class="text-[9px] text-slate-400 mt-2 text-center">Add space around the diagram</p>
                    </div>

                    <div class="absolute inset-0 overflow-auto flex p-2 custom-scrollbar"
                         ref="canvasContainerRef"
                         style="cursor: grab;"
                         @wheel.prevent="handleWheel"
                         @mousedown="startPan"
                         @mousemove="doPan"
                         @mouseup="endPan"
                         @mouseleave="endPan">
                        <div v-if="svgContent" v-html="svgContent" ref="svgContainer"
                            :key="`svg-${mode}-${selectedResultIndex}-${results.length}`"
                            :style="{transform: `scale(${zoom})`, transformOrigin: 'top center', transition: 'transform 0.2s'}"
                            class="shadow-xl bg-white m-auto origin-top">
                        </div>
                    </div>

                    <!-- Feature Color Picker Popup -->
                    <div v-if="clickedFeature"
                         class="fixed z-50 bg-white rounded-xl shadow-2xl border border-slate-200 p-6 min-w-[420px]"
                         :style="{ top: clickedFeaturePos.y + 'px', left: clickedFeaturePos.x + 'px' }">
                        <div class="flex items-center gap-3 mb-5 pb-4 border-b border-slate-100">
                            <div class="w-5 h-5 rounded" :style="{ backgroundColor: clickedFeature.color }"></div>
                            <span class="text-lg font-bold text-slate-700 truncate max-w-[320px]">{{ clickedFeature.label }}</span>
                            <button @click="clickedFeature = null" class="text-slate-400 hover:text-slate-600 ml-auto text-2xl">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>
                        <div class="mb-5">
                            <label class="text-sm font-medium text-slate-500 block mb-2">Legend name (optional)</label>
                            <input type="text"
                                   v-model="clickedFeature.legendName"
                                   :placeholder="clickedFeature.label"
                                   class="w-full text-base border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100">
                        </div>
                        <div class="mb-5">
                            <label class="text-sm font-medium text-slate-500 block mb-2">Fill Color</label>
                            <div class="flex items-center gap-4">
                                <input type="color"
                                       :value="clickedFeature.color"
                                       @input="clickedFeature.color = $event.target.value"
                                       @change="updateClickedFeatureColor($event.target.value)"
                                       class="w-16 h-12 cursor-pointer border-2 border-slate-200 rounded-lg">
                                <span class="text-base font-mono text-slate-600 bg-slate-50 px-4 py-3 rounded-lg">{{ clickedFeature.color }}</span>
                                <button @click="resetClickedFeatureFillColor"
                                        class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100"
                                        title="Reset fill color to default">
                                    <i class="ph ph-arrow-counter-clockwise text-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-500 block mb-2">Stroke</label>
                            <div class="flex items-center gap-4">
                                <input type="color"
                                       :value="clickedFeature.strokeColor || '#000000'"
                                       @input="clickedFeature.strokeColor = $event.target.value"
                                       @change="updateClickedFeatureStroke($event.target.value, null)"
                                       class="w-12 h-10 cursor-pointer border-2 border-slate-200 rounded-lg"
                                       title="Stroke color">
                                <input type="number"
                                       :value="clickedFeature.strokeWidth"
                                       @input="clickedFeature.strokeWidth = $event.target.value"
                                       @change="updateClickedFeatureStroke(null, $event.target.value)"
                                       class="w-20 text-base border border-slate-200 rounded-lg px-3 py-2"
                                       placeholder="Width"
                                       step="0.1"
                                       min="0"
                                       title="Stroke width">
                                <button @click="resetClickedFeatureStroke"
                                        class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100"
                                        title="Reset stroke to default">
                                    <i class="ph ph-arrow-counter-clockwise text-lg"></i>
                                </button>
                                <button @click="applyStrokeToAllSiblings"
                                        class="text-slate-400 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50"
                                        title="Apply this stroke to all features with the same legend">
                                    <i class="ph ph-users-three text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Color Change Scope Dialog -->
                    <div v-if="colorScopeDialog.show"
                         class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center">
                        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4">
                            <h3 class="text-lg font-bold text-slate-800 mb-2">Color Change Scope</h3>
                            <p class="text-sm text-slate-600 mb-4">
                                <template v-if="colorScopeDialog.matchingRule">
                                    This feature matches the rule "<span class="font-bold text-blue-600">{{ colorScopeDialog.matchingRule?.cap || colorScopeDialog.matchingRule?.val }}</span>" ({{ colorScopeDialog.ruleMatchCount }} features).
                                    <template v-if="colorScopeDialog.siblingCount > 0">
                                        <br>Caption "<span class="font-bold text-green-600">{{ colorScopeDialog.legendName }}</span>" is shared by {{ colorScopeDialog.siblingCount + 1 }} features.
                                    </template>
                                </template>
                                <template v-else-if="colorScopeDialog.siblingCount > 0">
                                    There are <span class="font-bold text-blue-600">{{ colorScopeDialog.siblingCount }}</span> other features with the caption "<span class="font-bold text-blue-600">{{ colorScopeDialog.legendName }}</span>".
                                </template>
                                <template v-else>
                                    How do you want to apply the color change?
                                </template>
                            </p>

                            <div class="flex flex-col gap-2">
                                <!-- Apply to all features matching the rule (when rule exists) -->
                                <button v-if="colorScopeDialog.matchingRule"
                                        @click="handleColorScopeChoice('rule')"
                                        class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-users text-lg"></i>
                                    <span>Apply to all "{{ colorScopeDialog.matchingRule?.cap || colorScopeDialog.matchingRule?.val }}" ({{ colorScopeDialog.ruleMatchCount }})</span>
                                </button>

                                <!-- Apply to all features with same caption (when siblings exist) -->
                                <button v-if="colorScopeDialog.siblingCount > 0"
                                        @click="handleColorScopeChoice('caption')"
                                        class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-users-three text-lg"></i>
                                    <span>Apply to all "{{ colorScopeDialog.legendName }}" ({{ colorScopeDialog.siblingCount + 1 }})</span>
                                </button>

                                <!-- Apply to this feature only -->
                                <button @click="handleColorScopeChoice('single')"
                                        class="w-full px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-user text-lg"></i>
                                    <span>This feature only</span>
                                </button>

                                <!-- Apply to all features with same individual label (when feature belongs to multi-feature rule and has label siblings) -->
                                <!-- Hide this button if individualLabel === legendName to avoid duplicate buttons -->
                                <button v-if="colorScopeDialog.matchingRule && colorScopeDialog.ruleMatchCount > 1 && colorScopeDialog.individualLabelSiblingCount > 0 && colorScopeDialog.individualLabel !== colorScopeDialog.legendName"
                                        @click="handleColorScopeChoice('individualLabel')"
                                        class="w-full px-4 py-2 bg-teal-100 hover:bg-teal-200 text-teal-800 font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-users text-lg"></i>
                                    <span>Apply to all "{{ colorScopeDialog.individualLabel }}" ({{ colorScopeDialog.individualLabelSiblingCount + 1 }})</span>
                                </button>

                                <!-- Use existing caption color (if available) -->
                                <button v-if="colorScopeDialog.existingCaptionColor"
                                        @click="handleColorScopeChoice('useExisting')"
                                        class="w-full px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <span class="w-5 h-5 rounded border border-purple-300 shrink-0"
                                          :style="{ backgroundColor: colorScopeDialog.existingCaptionColor }"></span>
                                    <span>Use existing "{{ colorScopeDialog.legendName }}" color</span>
                                </button>
                            </div>

                            <button @click="handleColorScopeChoice('cancel')"
                                    class="w-full mt-3 px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Reset Color Dialog -->
                    <div v-if="resetColorDialog.show"
                         class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center">
                        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md mx-4">
                            <h3 class="text-lg font-bold text-slate-800 mb-2">Reset Fill Color</h3>
                            <p class="text-sm text-slate-600 mb-4">
                                There are <span class="font-bold text-blue-600">{{ resetColorDialog.siblingCount }}</span> other features with the caption "<span class="font-bold text-blue-600">{{ resetColorDialog.caption }}</span>".
                                <br>How do you want to reset the color?
                            </p>

                            <div class="flex flex-col gap-2">
                                <!-- Reset all features with same caption -->
                                <button @click="handleResetColorChoice('all')"
                                        class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-users text-lg"></i>
                                    <span>Reset all "{{ resetColorDialog.caption }}" ({{ resetColorDialog.siblingCount + 1 }})</span>
                                </button>

                                <!-- Reset this feature only with new legend entry -->
                                <button @click="handleResetColorChoice('this_with_legend')"
                                        class="w-full px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-800 font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-user-plus text-lg"></i>
                                    <span>This only + add legend entry</span>
                                </button>

                                <!-- Reset this feature only -->
                                <button @click="handleResetColorChoice('this')"
                                        class="w-full px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg transition-colors text-left flex items-center gap-2">
                                    <i class="ph ph-user text-lg"></i>
                                    <span>This feature only</span>
                                </button>
                            </div>

                            <button @click="resetColorDialog.show = false"
                                    class="w-full mt-3 px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Legend Editor Toggle Button -->
                <button v-if="svgContent"
                        @click="showLegendPanel = !showLegendPanel"
                        class="absolute top-1/3 -translate-y-1/2 bg-purple-600 hover:bg-purple-700 text-white px-2 py-4 rounded-l-lg shadow-lg z-20 transition-all"
                        :style="{ right: (showFeaturePanel ? 320 : 0) + (showLegendPanel ? 288 : 0) + 'px' }"
                        :title="showLegendPanel ? 'Close legend editor' : 'Edit legend'">
                    <i class="ph ph-list-bullets text-lg"></i>
                </button>

                <!-- Legend Editor Panel -->
                <div v-if="svgContent"
                     class="absolute top-0 bottom-0 w-72 bg-white border-l border-slate-200 shadow-xl z-10 transition-all duration-300 flex flex-col"
                     :style="{ right: showLegendPanel ? (showFeaturePanel ? '320px' : '0') : '-288px' }">
                    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between shrink-0 bg-purple-50">
                        <div class="flex items-center gap-2">
                            <i class="ph ph-list-bullets text-purple-600"></i>
                            <span class="font-bold text-slate-700">Legend Editor</span>
                        </div>
                        <button @click="showLegendPanel = false" class="text-slate-400 hover:text-slate-600" aria-label="Close legend editor">
                            <i class="ph ph-x text-lg"></i>
                        </button>
                    </div>

                    <!-- Legend position controls -->
                    <div class="px-3 py-2 border-b border-slate-100 bg-slate-50/50">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-slate-500 flex items-center gap-1">
                                <i class="ph ph-hand-grabbing"></i> Drag legend to reposition
                            </span>
                            <div class="flex items-center gap-1">
                                <!-- Sort buttons -->
                                <button @click="sortLegendEntries('asc')"
                                        class="text-[10px] text-slate-500 hover:text-slate-700 p-1 rounded hover:bg-slate-100 transition-colors"
                                        title="Sort A-Z">
                                    <i class="ph ph-sort-ascending"></i>
                                </button>
                                <button @click="sortLegendEntries('desc')"
                                        class="text-[10px] text-slate-500 hover:text-slate-700 p-1 rounded hover:bg-slate-100 transition-colors"
                                        title="Sort Z-A">
                                    <i class="ph ph-sort-descending"></i>
                                </button>
                                <button @click="sortLegendEntriesByDefault"
                                        class="text-[10px] text-slate-500 hover:text-slate-700 p-1 rounded hover:bg-slate-100 transition-colors"
                                        title="Sort by default (generation order)">
                                    <i class="ph ph-list-numbers"></i>
                                </button>
                                <span class="text-slate-300">|</span>
                                <button @click="resetLegendPosition"
                                        class="text-[10px] text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-50 transition-colors"
                                        title="Reset legend position and restore deleted entries">
                                    <i class="ph ph-arrow-counter-clockwise"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-3 space-y-2">
                        <div v-for="(entry, idx) in legendEntries" :key="idx"
                             class="p-2 bg-slate-50 rounded border border-slate-100">
                            <!-- Main row: Up/Down, Color, Caption, Delete -->
                            <div class="flex items-center gap-1">
                                <!-- Up/Down buttons -->
                                <div class="flex flex-col shrink-0">
                                    <button @click="moveLegendEntryUp(idx)"
                                            :disabled="idx === 0"
                                            class="text-slate-400 hover:text-slate-600 disabled:text-slate-200 disabled:cursor-not-allowed p-0 leading-none"
                                            title="Move up">
                                        <i class="ph ph-caret-up text-xs"></i>
                                    </button>
                                    <button @click="moveLegendEntryDown(idx)"
                                            :disabled="idx === legendEntries.length - 1"
                                            class="text-slate-400 hover:text-slate-600 disabled:text-slate-200 disabled:cursor-not-allowed p-0 leading-none"
                                            title="Move down">
                                        <i class="ph ph-caret-down text-xs"></i>
                                    </button>
                                </div>
                                <!-- Color display (read-only) -->
                                <div class="w-6 h-6 rounded border border-slate-300 shrink-0"
                                     :style="{ backgroundColor: entry.color }"
                                     :title="entry.color"></div>
                                <input type="text"
                                       :value="entry.caption"
                                       @change="updateLegendEntryCaption(idx, $event.target.value)"
                                       class="flex-1 text-xs border border-slate-200 rounded px-2 py-1 min-w-0">
                                <!-- Expand/Collapse stroke options -->
                                <button @click="entry.showStroke = !entry.showStroke"
                                        class="text-slate-400 hover:text-slate-600 shrink-0 p-0.5"
                                        :title="entry.showStroke ? 'Hide stroke options' : 'Show stroke options'">
                                    <i class="ph text-xs" :class="entry.showStroke ? 'ph-caret-up' : 'ph-sliders-horizontal'"></i>
                                </button>
                                <button @click="deleteLegendEntry(idx)"
                                        class="text-red-400 hover:text-red-600 shrink-0"
                                        title="Remove entry">
                                    <i class="ph ph-trash text-sm"></i>
                                </button>
                            </div>
                            <!-- Stroke options row (collapsible) -->
                            <div v-if="entry.showStroke" class="mt-2 pt-2 border-t border-slate-200 flex items-center gap-2 text-[10px]">
                                <span class="text-slate-500 shrink-0">Stroke:</span>
                                <input type="color"
                                       :value="getLegendEntryStrokeColor(idx)"
                                       @change="updateLegendEntryStrokeColor(idx, $event.target.value)"
                                       class="w-6 h-5 p-0 border rounded shrink-0 cursor-pointer"
                                       title="Stroke color">
                                <input type="number"
                                       :value="getLegendEntryStrokeWidth(idx)"
                                       @change="updateLegendEntryStrokeWidth(idx, $event.target.value)"
                                       class="w-14 text-[10px] border border-slate-200 rounded px-1 py-0.5"
                                       placeholder="Width"
                                       step="0.5"
                                       min="0"
                                       title="Stroke width (Enter to apply)">
                                <button @click="resetLegendEntryStroke(idx)"
                                        class="text-slate-400 hover:text-slate-600 shrink-0"
                                        title="Reset stroke to default">
                                    <i class="ph ph-arrow-counter-clockwise text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div v-if="legendEntries.length === 0" class="text-center text-slate-400 text-sm py-4">
                            No legend entries found
                        </div>
                    </div>

                    <!-- Reset All Strokes button -->
                    <div class="px-3 py-2 border-t border-slate-200">
                        <button @click="resetAllStrokes"
                                class="w-full text-xs px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded flex items-center justify-center gap-1 transition-colors"
                                title="Reset all stroke colors and widths to default">
                            <i class="ph ph-arrow-counter-clockwise"></i>
                            Reset All Strokes
                        </button>
                    </div>

                    <!-- Info message -->
                    <div class="p-3 border-t border-slate-200 bg-slate-50 text-xs text-slate-500">
                        <i class="ph ph-info"></i> Colors are managed via Feature Colors panel
                    </div>
                </div>

                <!-- Feature Color Editor Toggle Button (floating) -->
                <button v-if="extractedFeatures.length > 0"
                        @click="showFeaturePanel = !showFeaturePanel"
                        class="absolute right-0 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white px-2 py-4 rounded-l-lg shadow-lg z-20 transition-all"
                        :class="{ 'translate-x-0': !showFeaturePanel, '-translate-x-80': showFeaturePanel }"
                        :title="showFeaturePanel ? 'Close color panel' : 'Open color panel'">
                    <i class="ph ph-paint-brush text-lg"></i>
                </button>

                <!-- Feature Color Editor Drawer (slides from right) -->
                <div v-if="extractedFeatures.length > 0"
                     class="absolute right-0 top-0 bottom-0 w-80 bg-white border-l border-slate-200 shadow-xl z-10 transition-transform duration-300 flex flex-col"
                     :class="showFeaturePanel ? 'translate-x-0' : 'translate-x-full'">
                    <!-- Header -->
                    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between shrink-0 bg-slate-50">
                        <div class="flex items-center gap-2">
                            <i class="ph ph-paint-brush text-blue-600"></i>
                            <span class="font-bold text-slate-700">Feature Colors</span>
                            <span class="text-xs text-slate-400">({{ filteredFeatures.length }})</span>
                        </div>
                        <button @click="showFeaturePanel = false" class="text-slate-400 hover:text-slate-600" aria-label="Close feature color editor">
                            <i class="ph ph-x text-lg"></i>
                        </button>
                    </div>

                    <!-- Record Selector (for multi-record files) -->
                    <div v-if="featureRecordIds.length > 1" class="px-4 py-2 border-b border-slate-100 shrink-0">
                        <select v-model="selectedFeatureRecordIdx" class="form-select text-xs w-full">
                            <option v-for="(rid, idx) in featureRecordIds" :key="idx" :value="idx">
                                {{ rid }}
                            </option>
                        </select>
                    </div>

                    <!-- Search -->
                    <div class="px-4 py-2 border-b border-slate-100 shrink-0">
                        <input v-model="featureSearch" placeholder="Search by product, gene, locus_tag..."
                               class="form-input text-xs w-full">
                    </div>

                    <!-- Feature List -->
                    <div class="flex-grow overflow-y-auto">
                        <div v-for="feat in filteredFeatures" :key="feat.id"
                             @click="$event.currentTarget.querySelector('input[type=color]')?.click()"
                             class="flex items-center gap-2 px-3 py-2 border-b border-slate-100 text-xs hover:bg-blue-50 cursor-pointer transition-colors">
                            <span class="w-10 font-mono text-slate-400 shrink-0 text-[10px]">{{ feat.type }}</span>
                            <span class="w-16 font-mono text-slate-500 shrink-0 truncate text-[10px]" :title="`${feat.start}..${feat.end}`">
                                {{ feat.start }}..{{ feat.end }}
                            </span>
                            <span class="flex-grow truncate text-slate-700"
                                  :title="feat.product || feat.gene || feat.locus_tag || feat.note || '(unnamed)'">
                                {{ feat.product || feat.gene || feat.locus_tag || feat.note || '(unnamed)' }}
                            </span>
                            <input type="color"
                                   :value="getFeatureColor(feat)"
                                   @click.stop
                                   @change="setFeatureColor(feat, $event.target.value)"
                                   :disabled="!canEditFeatureColor(feat)"
                                   :title="canEditFeatureColor(feat) ? 'Click to change color' : 'No identifier available (no locus_tag, gene, or product)'"
                                   :class="['w-7 h-5 border rounded shrink-0', canEditFeatureColor(feat) ? 'cursor-pointer' : 'cursor-not-allowed opacity-50']">
                        </div>
                        <div v-if="filteredFeatures.length === 0" class="p-4 text-center text-slate-400 text-xs">
                            No features found
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="px-4 py-2 border-t border-slate-200 shrink-0 bg-slate-50">
                        <p class="text-[10px] text-slate-400">
                            <i class="ph ph-info"></i> Click a feature or the diagram to change colors.
                        </p>
                    </div>
                </div>
            </div>

            <div v-else class="h-full flex flex-col items-center justify-center text-slate-300 border-4 border-dashed border-slate-200 rounded-3xl p-12 bg-slate-50/30">
                <i class="ph ph-dna text-6xl mb-4 text-slate-200"></i>
                <p class="font-medium text-slate-400">Configure settings and click Generate</p>
            </div>
        </div>
    </main>

    <footer class="bg-slate-50 border-t border-slate-200 px-4 py-2 text-sm text-slate-500 flex items-center justify-center gap-6 shrink-0 h-8">
        <span>
            <strong>Disclaimer:</strong> This tool is provided "as is" without warranty of any kind.
        </span>
        <span>
            License: <a href="https://github.com/satoshikawato/gbdraw/blob/main/LICENSE.txt" target="_blank" rel="noopener noreferrer" class="hover:underline hover:text-slate-700">MIT</a> |
            Author: <a href="https://researchmap.jp/satoshi_kawato?lang=en" target="_blank" rel="noopener noreferrer" class="hover:underline hover:text-slate-700">Satoshi Kawato</a>
        </span>
    </footer>
</div>

<script type="text/x-template" id="help-tip-template">
    <div class="inline-block ml-1 align-text-bottom">
        <i class="ph ph-question text-slate-400 hover:text-blue-500 cursor-help"
           @mouseenter="show" @mouseleave="hide" ref="trigger"></i>
        <Teleport to="body">
            <div v-if="visible" :style="style" class="fixed z-[9999] px-3 py-2 bg-slate-800 text-white text-xs rounded-md shadow-lg max-w-[250px] pointer-events-none transition-opacity text-left leading-relaxed">
                 {{ text }}
            </div>
        </Teleport>
    </div>
</script>

<script type="text/x-template" id="file-uploader-template">
    <div class="w-full">
        <div class="flex justify-between items-end mb-1">
            <label class="input-label mb-0">{{ label }}</label>
            <button v-if="modelValue" @click.stop="clearFile" class="text-[10px] text-red-500 hover:text-red-700 flex items-center gap-1"><i class="ph ph-trash"></i> Remove</button>
        </div>
        <div class="upload-zone cursor-pointer" :class="{'ready': modelValue, 'py-1 min-h-[36px]': small}" @click="$refs.input.click()">
            <input type="file" ref="input" @change="handleFile" class="hidden">
            <div v-if="!modelValue" class="flex items-center justify-center gap-2 text-slate-400 group-hover:text-blue-600 transition-colors">
                <i class="ph ph-upload-simple" :class="small ? 'text-base' : 'text-xl'"></i>
                <span :class="small ? 'text-[10px]' : 'text-xs font-bold'">Click to Browse</span>
            </div>
            <div v-else class="text-green-700 font-bold truncate w-full px-2 flex items-center justify-center gap-2" :class="small ? 'text-[10px]' : 'text-xs'">
                <i class="ph ph-check-circle text-lg"></i>
                <span>{{ modelValue.name }}</span>
            </div>
        </div>
    </div>
</script>

<script type="module" src="./js/app.js"></script>
</body>
</html>
